
# 浏览器输入 URL 到渲染过程

## 一、输入 URL  
- 输入 URL，按下 Enter 键。  
- 浏览器检查是否为搜索关键词。  
- 如果 URL 不完整，则跳转到默认的搜索引擎。

## 二、解析 URL  
- 提取出协议（如 `http`、`https`）、域名、端口和路径等信息。

## 三、DNS 解析（域名解析）  
1. 按照以下顺序依次查询缓存：
   - 浏览器缓存
   - 操作系统缓存
   - 路由器缓存
   - ISP DNS 服务器缓存
2. 如果都未命中，则通过递归和迭代方式向根域名、顶级域名、权威域名服务器请求 IP 地址。
3. 最终找到 IP 并更新各级缓存。

#### 优化点：
- 使用 `<link rel="dns-prefetch">` 和 `<link rel="preconnect">` 预先提取解析 DNS 并建立连接。

## 四、TCP 连接  
- **三次握手**：
  1. 客户端 → 服务端：发送 `SYN` 请求建立连接。
  2. 服务端 → 客户端：发送 `SYN-ACK` 表示收到并同意建立连接。
  3. 客户端 → 服务端：发送 `ACK` 确认连接建立。

- **TLS 握手（HTTPS）**：
  1. 客户端 → 服务端：发送随机数、加密套件列表、TLS 版本。
  2. 服务端 → 客户端：发送随机数、选择的加密套件、含公钥的证书。
  3. 客户端生成主密钥，使用公钥加密后发送给服务端。
  4. 双方生成会话密钥，后续通信使用对称加密。

## 五、发起请求  
- 发送请求报文，包括：
  - 请求行（如 GET /index.html HTTP/1.1）
  - 请求头（如 Host、User-Agent）
  - 请求体（可选）

## 六、接收请求并响应  
- **CDN 分发**：请求可能被分发到就近 CDN 节点服务器。
- **缓存检查**：
  - 强缓存：`Cache-Control: max-age=xxx`，直接返回 `200`
  - 协商缓存：
    - `Last-Modified` / `If-Modified-Since`
    - `ETag` / `If-None-Match`
    - 若未修改则返回 `304 Not Modified`

- **重定向**：
  - `301` 永久重定向：下次不再走重定向
  - `302` 临时重定向：每次请求都会走重定向

- **业务逻辑处理**：
  - 查询数据库
  - 模板渲染（SSR）
  - 返回响应报文（状态码、响应头、响应体）

#### 优化点：
- 尽量避免重定向，减少网络往返时间。
- 合理设置缓存以加快页面加载速度。
- 使用 CDN 加速资源加载。

## 七、接收响应并解析  
- **HTML 解析**：构建 DOM 树。
- **CSS 解析**：构建 CSSOM 树。  
  - JS 加载可能会阻塞 CSSOM 构建，进而阻塞页面渲染。  
  - 可使用 `async` 或 `defer` 属性解决。
- **合并 DOM 和 CSSOM**：生成 Render Tree。
- **布局（Layout）**：计算元素大小和位置。
- **绘制（Paint）**：将像素绘制到屏幕上。
- **合成（Composite）**：多个图层合并，提升渲染性能。

## 八、加载子资源  
- HTML 解析过程中可能触发 JS、CSS、图片等资源请求。
- 可能引起页面“重绘（Repaint）”和“回流（Reflow）”。

#### 优化点：
- 将 JS 放在 `<body>` 底部，避免阻塞渲染。
- 给 JS 添加 `async` 或 `defer` 属性，defer 按顺序执行，async 是异步无序执行，适用于不依赖页面 DOM 的脚本。
- 减少 DOM 嵌套层级，提高查找效率。
- 对关键资源使用 `<link rel="preload">` 预加载。
- 使用 `<link rel="prefetch">` 和 `<link rel="preconnect">` 提前请求和建立连接。
- 图片压缩与懒加载。
- 使用 SSR（服务端渲染）或 SSG（静态生成）。
- 使用 HTTP/2 或 HTTP/3 提升性能（多路复用、头部压缩等），多路复用解决了 HOL blocking，头部压缩减少传输体积。
- 使用内联CSS，减少 HTTP 请求。

## 九、页面加载完成  
- 触发 `window.onload` 事件。

## 十、断开连接  
- **四次挥手**：
  1. 客户端 → 服务端：发送 `FIN` 请求断开连接。
  2. 服务端 → 客户端：发送 `ACK` 确认。
  3. 服务端 → 客户端：发送 `FIN` 请求断开连接。
  4. 客户端 → 服务端：发送 `ACK` 确认。
- 等待 2MSL（最大报文段生存时间），确保最后一个 ACK 被接收，连接正式断开。
